---
title: "OmniAuthã®/auth/:providerã‚’é€šã—ã¦ã€GitHubã®èªè¨¼èªå¯ç”»é¢ã¸é·ç§»ã—ãªã„ã¨ãã®å¯¾å‡¦æ³•"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rails", "OmniAuth", "github"]
published: true
---

ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ Ruby on Railsã®ç¬¬6ç« ã€ŒRailsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã€ã«ãŠã„ã¦ã€OmniAuthã‚’ä½¿ã£ã¦ã€OAuthã‚’åˆ©ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã—ã¾ã—ãŸã€‚

https://gihyo.jp/book/2020/978-4-297-11462-6

ãã®éš›ã€GitHubã®èªè¨¼èªå¯ç”»é¢ã¸é·ç§»ã—ãªã‹ã£ãŸãŸã‚ã€ãã®å¯¾å‡¦æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚

æ›¸ç±ã®6-1ã‹ã‚‰6-3-2ã¾ã§ã®æ‰‹é †ã¯å®Œäº†æ¸ˆã¿ã¨ã—ã¾ã™ã€‚

## å®Ÿè£…

æ›¸ç±ã®6-3-3ã«ã¦ã€GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹æ©Ÿèƒ½ã®ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚

### Gemfile

```gemfile
...
gem 'omniauth'
gem 'omniauth-github'
gem 'omniauth-rails_csrf_protection'
...
```


### config/initializers/omniauth.rb

```ruby
Rails.application.config.middleware.use OmniAuth::Builder do
    if Rails.env.development? || Rails.env.test?
        provider :github, "YOUR_CLIENT_ID", "YOUR_CLIENT_SECRET"
    else
        provider :github,
          Rails.application.credentials.github[:client_id],
          Rails.application.credentials.github[:client_secret]
    end
end
```

### app/views/layouts/application.html.haml

```haml
...
  %body
    %header.navbar.navbar-expand-sm.navbar-light.bg-light
      .container
        = link_to "AwesomeEvents", root_path, class: "navbar-brand mr-auto"
        %ui.navbar-nav
          %li.nav-item
            = link_to "GitHubã§ãƒ­ã‚°ã‚¤ãƒ³", "/auth/github", class: "nav-link", method: :post
    .container
      - if flash.notice
        .alert.alert-success
          = flash.notice
      = yield
```

ã¾ãŸã€ã“ã®æ™‚ç‚¹ã§ã€6-3-4ã®ãƒ¦ãƒ¼ã‚¶ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆã¾ã§å®Œäº†æ¸ˆã¿ã§ã™ã€‚

## å¯¾å‡¦

Rails Serverèµ·å‹•

```bash
bin/rails s
=> Booting Puma
=> Rails 7.1.3.4 application starting in development 
=> Run `bin/rails server --help` for more startup options
Puma starting in single mode...
* Puma version: 6.4.2 (ruby 3.2.2-p53) ("The Eagle of Durango")
*  Min threads: 5
*  Max threads: 5
*  Environment: development
*          PID: 56744
* Listening on http://127.0.0.1:3000
* Listening on http://[::1]:3000
Use Ctrl-C to stop
```

ãã®å¾Œã€http://127.0.0.1:3000ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã€ŒGitHubã§ãƒ­ã‚°ã‚¤ãƒ³ã€ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨ã€`Routing Error No route matches [GET] "/auth/github"`ã¨ãªã‚‹ã€‚

å¯¾å‡¦ã¨ã—ã¦ã€`config/initializers/omniauth.rb`ã«`OmniAuth.config.allowed_request_methods = [:post, :get]`ã‚’è¿½åŠ ã™ã‚‹ã¨ã€é·ç§»ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

æ›¸ç±ã«ã‚‚ã‚ã‚‹é€šã‚Šã€GitHubã‚’å”¯ä¸€ã®èªè¨¼æ–¹æ³•ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€CSRFã¯è„…å¨ã§ã¯ãªã„ãŸã‚ã€`config/initializers/omniauth.rb`ã«æ¬¡ã®è¡Œã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€GETãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®‰å…¨ã«æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ruby
OmniAuth.config.allowed_request_methods = [:post, :get]

Rails.application.config.middleware.use OmniAuth::Builder do
    if Rails.env.development? || Rails.env.test?
        provider :github, "YOUR_CLIENT_ID", "YOUR_CLIENT_SECRET"
    else
        provider :github,
          Rails.application.credentials.github[:client_id],
          Rails.application.credentials.github[:client_secret]
    end
end
```

## å‚è€ƒ
https://stackoverflow.com/questions/65995219/omniauth-isnt-catching-the-initial-get-auth-provider-request
