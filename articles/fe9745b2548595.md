---
title: "Cloud Functionsã®HTTPãƒˆãƒªã‚¬ãƒ¼ã‚’ä½¿ã£ã¦ï¼ŒSlackã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸é€šçŸ¥ã™ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Python, Slack, Tech, cloudfunctions]
published: false
---

Python Slack SDKã‹ã‚‰Slackã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸é€šçŸ¥ã™ã‚‹ä»•çµ„ã¿ã‚’Google Cloud Functionsã§å®Ÿç¾ã—ã¾ã™ã€‚
Slack Appã¯ï¼Œå‰å›ã®è¨˜äº‹ã§ä½œæˆã—ãŸã‚‚ã®ã‚’ç”¨ã„ã¾ã™ã€‚

https://zenn.dev/tossy21/articles/c9ff5d1e24b407

# Cloud Functionsã§Slackã¸é€šçŸ¥ã™ã‚‹é–¢æ•°ã‚’ä½œæˆ

Cloud Functionsã§é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã¯å‰å›åŒæ§˜ã®ã‚‚ã®ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’`main.py`ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
Cloud Functionsã§ã¯ï¼Œé–¢æ•°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹`main.py`ã¨ã„ã†åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

https://cloud.google.com/functions/docs/writing?hl=ja#directory-structure

```python
import functions_framework
import logging
import os

# Import WebClient from Python SDK (github.com/slackapi/python-slack-sdk)
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError

@functions_framework.http
def my_function(request):
    # WebClient instantiates a client that can call API methods
    # When using Bolt, you can use either `app.client` or the `client` passed to listeners.
    client = WebClient(token=os.environ.get("SLACK_BOT_TOKEN"))
    logger = logging.getLogger(__name__)

    # ID of the channel you want to send the message to
    channel_id = "YOUR_ID"

    try:
        # Call the chat.postMessage method using the WebClient
        result = client.chat_postMessage(channel=channel_id, text="Hello world")
        logger.info(result)
        return "success"

    except SlackApiError as e:
        logger.error(f"Error posting message: {e}")
        return "error"
```

åŒæ§˜ã«ï¼Œå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ï¼Œ`requirements.txt`ã«è¨˜è¼‰ã—ã¾ã™ã€‚

```txt
slack_sdk==3.23.0
```

# ãƒ‡ãƒ—ãƒ­ã‚¤

ç’°å¢ƒå¤‰æ•°`SLACK_BOT_TOKEN`ã¯`--set-env-vars`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¦æŒ‡å®šã—ã¾ã™ã€‚

```bash
gcloud functions deploy my_function --set-env-vars SLACK_BOT_TOKEN=YOUR_TOKEN --trigger-http --runtime=python311 --no-allow-unauthenticated --source=. --gen2
```

# Slackã¸ã®é€šçŸ¥ã‚’ç¢ºèª

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã¯ï¼Œè©²å½“ã®URLã«å¯¾ã—ã¦ï¼Œcurlã‚³ãƒãƒ³ãƒ‰ã‚’å©ãï¼Œé–¢æ•°ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
ã¾ãšï¼ŒURLã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
gcloud functions describe my_function --gen2 --region REGION --format="value(serviceConfig.uri)"

https://my-function-xxxxxxxx-xx.a.run.app
```

ãã®å¾Œï¼Œè©²å½“ã®URLã¸curlã‚’å©ãã¾ã™ã€‚

```bash
curl -m 70 -X POST URL -H "Authorization: Bearer $(gcloud auth print-identity-token)" -H "Content-Type: application/json" -d '{}'
```

https://cloud.google.com/functions/docs/create-deploy-gcloud?hl=ja#triggering_the_function


è¨­å®šã—ãŸSlackã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸é€šçŸ¥ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚