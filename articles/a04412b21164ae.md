---
title: "ã¯ã˜ã‚ã¦ã¿ã‚ˆã† Google Cloud ãƒãƒ³ã‚ºã‚ªãƒ³ Cloud Runç·¨ã‚’è©¦ã™ï¼ˆgcloudè¨­å®šã€Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [GCP, GitHub, cloudrun, artifactregistry]
published: true
---


# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®ã€ã€Œã¯ã˜ã‚ã¦ã¿ã‚ˆã† Google Cloud ãƒãƒ³ã‚ºã‚ªãƒ³ Cloud Run ç·¨ã€ã®gcloudè¨­å®šã‚„Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦ã—ã¾ã™ã€‚

https://github.com/google-cloud-japan/gcp-getting-started-cloudrun

# ç’°å¢ƒ

å®Ÿè¡Œã—ãŸMacbook Proã®ã‚¹ãƒšãƒƒã‚¯ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```
ãƒ¡ãƒ¢ãƒªï¼š64GB
ãƒ—ãƒ­ã‚»ãƒƒã‚µï¼šIntel Core i9 8ã‚³ã‚¢
OSï¼šVentura 13.4.1(c) 
```

# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

ã¯ã˜ã‚ã«è©²å½“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãŠãã¾ã™ã€‚

```bash
git clone git@github.com:google-cloud-japan/gcp-getting-started-cloudrun.git
```


# gcloudã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¯ã˜ã‚ã«gcloudã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
brew install --cask google-cloud-sdk
```

`~/.zshrc`ã«ä»¥ä¸‹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚

```
source "/usr/local/share/google-cloud-sdk/completion.zsh.inc"
source "/usr/local/share/google-cloud-sdk/path.zsh.inc"
```

`~/.zshrc`ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚

```bash
source ~/.zshrc
```

gcloudã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
gcloud --version

Google Cloud SDK 439.0.0
beta 2023.07.14
bq 2.0.94
core 2023.07.14
gcloud-crc32c 1.0.0
gsutil 5.25
```


# Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š

## å¯¾è±¡ã® Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š
Google Cloudãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¾ã™ã€‚

```bash
export PROJECT_ID=[PROJECT_ID]
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¯ã€[ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://console.cloud.google.com/home/dashboard)ã«é€²ã¿ã€å·¦ä¸Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‹ã‚‰ç¢ºèªã—ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª²é‡‘ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

```bash
gcloud beta billing projects describe ${PROJECT_ID} | grep billingEnabled
```

æœ‰åŠ¹åŒ–ã§ãã¦ã„ã‚Œã°ã€ä»¥ä¸‹ã®è¡¨ç¤ºã«ãªã‚Šã¾ã—ãŸã€‚

```bash
billingEnabled: true
```

# gcloudã®è¨­å®š

## gcloud ã‹ã‚‰åˆ©ç”¨ã™ã‚‹ Google Cloud ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®š

```bash
gcloud config set project ${PROJECT_ID}
```

## gcloud ã‹ã‚‰ã® Cloud Run ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š

```bash
gcloud config set run/region asia-northeast1
gcloud config set run/platform managed
```

## åˆ©ç”¨ã™ã‚‹æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–

```bash
gcloud services enable artifactregistry.googleapis.com run.googleapis.com cloudbuild.googleapis.com sourcerepo.googleapis.com container.googleapis.com
```

# ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ãƒãƒ³ã‚ºã‚ªãƒ³ã§åˆ©ç”¨ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯`sumservice`ã¨å‘¼ã³ã€REST APIã§å…¬é–‹ã—ã¾ã™ã€‚

å›ºå®šæ–‡å­—åˆ—ã‚’è¿”ã™`Hello Challenger API`ã¨æ•°å€¤ã®åˆè¨ˆã‚’è¿”ã™`æ•°å€¤åˆè¨ˆ API`ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ•ã‚©ãƒ«ãƒ€ã€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ä»¥ä¸‹ã¨ãªã£ã¦ã„ã¾ã™ã€‚
```
.
â””â”€ src
  Â  â””â”€ sumservice
 Â  Â     â”œâ”€ .dockerignore    # ã‚³ãƒ³ãƒ†ãƒŠã«å«ã‚ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã‚’æŒ‡å®šã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
 Â  Â     â”œâ”€ Dockerfile       # Docker ã‚³ãƒ³ãƒ†ãƒŠä½œæˆå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«
 Â Â      â”œâ”€ Procfile         # èµ·å‹•æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã€Buildpacks ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ãã«åˆ©ç”¨
 Â Â      â”œâ”€ main.py          # ãƒ¡ã‚¤ãƒ³é–¢æ•°ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«
 Â Â      â””â”€ requirements.txt # åˆ©ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸€è¦§
```

## Dockerfile

```Dockerfile
 Use the official lightweight Python image.
# https://hub.docker.com/_/python
FROM python:3.9-slim

# Allow statements and log messages to immediately appear in the Knative logs
ENV PYTHONUNBUFFERED True

# Copy local code to the container image.
ENV APP_HOME /app
WORKDIR $APP_HOME
COPY . ./

# Install dependencies.
RUN pip install -r requirements.txt

# Run the web service on container startup. Here we use the gunicorn
# webserver, with one worker process and 8 threads.
# For environments with multiple CPU cores, increase the number of workers
# to be equal to the cores available.
# Timeout is set to 0 to disable the timeouts of the workers to allow Cloud Run to handle instance scaling.
CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 main:app
```

## main.py

main.pyã¯Flaskã‚’ç”¨ã„ã¦APIã‚µãƒ¼ãƒã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚


```python

import os
import json
import requests

from flask import Flask, request, jsonify

app = Flask(__name__)


@app.route("/")
def hello_world():
    name = os.environ.get("NAME", "Challenger01")
    return "Hello {}!".format(name)


@app.route("/sum", methods=["POST"])
def sum_numbers():
    try:
        json_data = request.get_json()
    except:
        return jsonify({'error': 'Bad Request', 'message': 'Invalid request: {}'.format(request.get_data(as_text=True))}), 400
    if not 'numbers' in json_data:
        return jsonify({'error': 'Bad Request', 'message': 'Request format error: {}'.format(request.get_data(as_text=True))}), 400
    try:
        ans = sum(json_data['numbers'])
    except TypeError:
        return jsonify({'error': 'Bad Request', 'message': 'Request format error: {}'.format(request.get_data(as_text=True))}), 400
    return jsonify({'sum': ans}), 200




def retrieve_token(target_url):
    # Set up metadata server request
    metadata_server_token_url = 'http://metadata/computeMetadata/v1/instance/service-accounts/default/identity?audience='

    token_request_url = metadata_server_token_url + target_url
    token_request_headers = {'Metadata-Flavor': 'Google'}

    # Fetch the token
    token_response = requests.get(
        token_request_url, headers=token_request_headers)
    return token_response.content.decode("utf-8")


if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))

```


è©³ç´°ã¯ã€[ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³](https://github.com/google-cloud-japan/gcp-getting-started-cloudrun/blob/main/tutorial.md#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ã®ç« ã‚’ã”ç¢ºèªãã ã•ã„ã€‚

# Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯2ç¨®é¡ã‚ã‚Šã¾ã™ã€‚
* Dockerfileã‚’ä½¿ã„ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤
* Buildpacksã€Cloud Build ã‚’ä½¿ã„ã€Dockerfile ç„¡ã—ã€ã‹ã¤ãƒªãƒã‚¸ãƒˆãƒªã®æŒ‡å®šç„¡ã—ã«ãƒ‡ãƒ—ãƒ­ã‚¤

ä»Šå›ã¯å‰è€…ã‚’è©¦ã—ã¾ã™ã€‚

## Dockerfileã‚’ä½¿ã„ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤

ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã¯ã€ä»¥ä¸‹ã§ã™ã€‚
ã¾ãšã€Artifact Registryã‚’ä½œæˆã—ã¾ã™ã€‚
æ¬¡ã«ã€ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã¨Dockerfileã‚’å…ƒã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã€ãã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…ƒã«ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’Artifact Registryã¸pushã—ã¾ã™ã€‚ãã®å¾Œã€ãã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å…ƒã«Cloud Runã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

![](/images/step_by_step_deployment.png)

https://raw.githubusercontent.com/google-cloud-japan/gcp-getting-started-cloudrun/main/images/step_by_step_deployment.png

### Artifact Registryã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ

```bash
gcloud artifacts repositories create cloudrun-handson --repository-format=docker --location=asia-northeast1 --description="Docker repository for Cloud Run hands-on"
```

```bash
Create request issued for: [cloudrun-handson]
Waiting for operation [projects/${PROJECT_ID}/locations/asia-northeast1/operations/18c4a96d-296e-4c11-8e5c-cf3164fff021] to complete...done.                                 
Created repository [cloudrun-handson].
```

Artifact Registryã«ãƒªãƒã‚¸ãƒˆãƒªãŒä½œæˆã§ããŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/a04412b21164ae_create_artifact_registry_repository.png)

### docker ã‚³ãƒãƒ³ãƒ‰ã®èªè¨¼è¨­å®š

```bash
gcloud auth configure-docker asia-northeast1-docker.pkg.dev --quiet
```

```bash
...
Adding credentials for: asia-northeast1-docker.pkg.dev
```

### ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ

```bash
(cd src/sumservice && docker build -t asia-northeast1-docker.pkg.dev/${PROJECT_ID}/cloudrun-handson/sumservice:v1 .)
```

`docker images`ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½œæˆã§ããŸã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
docker images

REPOSITORY                                                                        TAG             IMAGE ID       CREATED         SIZE
asia-northeast1-docker.pkg.dev/${PROJECT_ID}/cloudrun-handson/sumservice   v1              b500b7ef15cc   6 seconds ago   161MB
```

### ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’Artifact Registryã¸pushã—ã¾ã™

```bash
docker push asia-northeast1-docker.pkg.dev/${PROJECT_ID}/cloudrun-handson/sumservice:v1
```

```bash
The push refers to repository [asia-northeast1-docker.pkg.dev/noted-ability-320105/cloudrun-handson/sumservice]
ba457e788bff: Pushed 
a5e3673b9369: Pushed 
8cc7b56b32c3: Pushed 
9bfcb9ca631e: Pushed 
ba4397078275: Pushed 
91c4ec8027b7: Pushed 
5f77f286226c: Pushed 
c6e34807c2d5: Pushed 
v1: digest: sha256:d6c2f5ced0e41fbdb5506e7dd6654d64a3cc2e1cc6d0b8156833fa0a5651f831 size: 1995
```

ãƒªãƒã‚¸ãƒˆãƒªã«pushã§ããŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

![](/images/a04412b21164ae_create_artifact_registry_image.png)


### Cloud Runã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™

Artifact Registryã¸ç™»éŒ²ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰Cloud Runã‚’èªè¨¼ãªã—ã§èµ·å‹•ã—ã¾ã™ã€‚

```bash
gcloud run deploy sumservice --image=asia-northeast1-docker.pkg.dev/${PROJECT_ID}/cloudrun-handson/sumservice:v1 --allow-unauthenticated
```

```bash
Enabling service [run.googleapis.com] on project [xxxxxxxxxxxxxx]...
Operation "operations/acf.p2-xxxxxxxxxxxxxx-f116d24a-e537-4139-8dac-0419b160a73f" finished successfully.
Deploying container to Cloud Run service [sumservice] in project [${PROJECT_ID}] region [asia-northeast1]
âœ“ Deploying new service... Done.                                                                         
  âœ“ Creating Revision...                                                                                 
  âœ“ Routing traffic...                                                                                   
  âœ“ Setting IAM Policy...                                                                                
Done.                                                                                                    
Service [sumservice] revision [sumservice-00001-qaq] has been deployed and is serving 100 percent of traffic.
Service URL: https://xxxxxxxxxx.a.run.app

```

### å‹•ä½œç¢ºèª

```bash
SUM_URL=$(gcloud run services describe sumservice --format json | jq -r '.status.address.url')
curl -s -H "Content-Type: application/json" -d '{"numbers": [10, 20, 30, 300, 100]}' ${SUM_URL}/sum | jq
```

ä»¥ä¸‹ãŒè¿”ã£ã¦ãã‚Œã°ã€æˆåŠŸã§ã™ã€‚

```bash
{
  "sum": 460
}

```

### ã‚µãƒ¼ãƒ“ã‚¹ã®å‰Šé™¤

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```bash
gcloud run services delete sumservice --quiet
```

# ãŠã‚ã‚Šã«

ã“ã®è¨˜äº‹ã§ã¯ã€ã€Œã¯ã˜ã‚ã¦ã¿ã‚ˆã† Google Cloud ãƒãƒ³ã‚ºã‚ªãƒ³ Cloud Run ç·¨ã€ã®gcloudã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‹ã‚‰Cloud Runã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã‚’è©¦ã—ã¾ã—ãŸã€‚