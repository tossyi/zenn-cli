---
title: "Cloud Buildã¨Artifact Registryã§CI/CDåŸºç›¤ã®æ§‹ç¯‰"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [GCP,"Cloud Build","Artifact Registry", CI/CD]
published: false
---

# ç›®çš„

ã“ã®è¨˜äº‹ã§ã¯ã€Cloud Buildã¨Artifact Registryã‚’ä½¿ã£ã¦CI/CDåŸºç›¤ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
GCPã®æ•™ç§‘æ›¸IIã€ã‚³ãƒ³ãƒ†ãƒŠé–‹ç™ºç·¨ã€‘ã®3ç« ã®Cloud Buildã‚’ãƒ™ãƒ¼ã‚¹ã«æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚

https://www.amazon.co.jp/GCP%E3%81%AE%E6%95%99%E7%A7%91%E6%9B%B8II-%E3%80%90%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E9%96%8B%E7%99%BA%E7%B7%A8%E3%80%91-Kubernetes%E3%81%A8GKE%E3%80%81Cloud-Run%E3%80%81%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%A1%E3%83%83%E3%82%B7%E3%83%A5%E3%82%92%E8%A9%B3%E8%A7%A3-%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89%E3%82%A8%E3%83%BC%E3%82%B9%E6%A0%AA%E5%BC%8F%E4%BC%9A%E7%A4%BE/dp/4865942416

# Cloud Buildã¨GCRã€GKEã«ã‚ˆã‚‹CI/CDåŸºç›¤æ§‹ç¯‰

ã“ã®ç« ã§ã¯ã€ã¾ãš3.5ç« ã®Cloud Buildã§CI/CDåŸºç›¤æ§‹ç¯‰ã‚’å®Ÿç¾ã—ã¦ã„ãã¾ã™ã€‚

## CSRãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆ

ã¾ãšã¯ã€CSRã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªåã¯ã€myrepositoryã¨ã—ã¾ã™ã€‚

```bash
gcloud source repos create myrepository
```

```bash
Created [myrepository].
```

## ã‚³ãƒ³ãƒ†ãƒŠã®æº–å‚™

ç¶šã„ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã‚Œã¯GCPå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã¨ãªã‚Šã¾ã™ã€‚
HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã¨ã€ã€ŒHello world!ã€ãŒè¿”ã£ã¦ãã¾ã™ã€‚

ä»¥ä¸‹ã¯main.goã§ã™ã€‚

```go
package main

import(	
	"fmt"
	"log"
	"net/http"
	"os"
)

func main() {
	port := "8080"
	if fromEnv := os.Getenv("PORT"); fromEnv != "" {
		port = fromEnv
	}
	server := http.NewServeMux()
	server.HandleFunc("/", hello)
	log.Printf("Server listinig on port %s", port)
	log.Fatal(http.ListenAndServe(fmt.Sprintf(":%s", port), server))

}

func hello(w http.ResponseWriter, r *http.Request) {
	log.Printf("Serving request: %s", r.URL.Path)
	host, _ := os.Hostname()
	fmt.Fprintln(w, "Hello, World!")
	fmt.Fprintf(w, "Version: 1.0.0\n")
	fmt.Fprintf(w, "Hostname: %s\n", host)
}

```

Dockerfileã¯ä»¥ä¸‹ã§ã™ã€‚

```Dockerfile
FROM golang:1.8-alpine
ADD . /go/src/hello-world
RUN go install hello-world

FROM alpine:latest
COPY --from=0 /go/bin/hello-world .
ENV PORT 8080
CMD ["./hello-world"]
```

## GKEã®ã‚¯ãƒ©ã‚¹ã‚¿ã¨ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã‚’k8s-sample.yamlã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚
NAME, PROJECT_ID, IMAGE_NAME, TAG_NAMEã¯è‡ªèº«ã®è¨­å®šã¸å¤‰æ›´ã—ã¾ã™ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: NAME
spec:
  replicas: 1
  selector:
    matchLabels:
      app: NAME
  template:
    metadata:
      labels:
        app: NAME
    spec:
      containers:
      - name: NAME
        image: NAME:latest
        ports:
        - containerPort: 8080
        image: gcr.io/PROJECT_ID/IMAGE_NAME/TAG_NAME:latest 
        resources:
          requests:
            memory: "128Mi"
            cpu: "500m"
---
kind: Service
apiVersion: v1
metadata:
  name: NAME
spec:
  type: LoadBalancer
  selector:
    app: NAME
  ports:
  - name: http
    port: 8080
    targetPort: 8080
```

GKEã®ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
gcloud container clusters create mycluster --num-nodes=3 --preemptible
```

å°‘ã€…æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

```bash
Creating cluster mycluster in us-east1-b... Cluster is being configured...
Cluster is being health-checked (master is healthy)...
done.                                                                                     
Created [https://container.googleapis.com/v1/projects/PROJECT_ID/zones/us-east1-b/clusters/mycluster].
To inspect the contents of your cluster, go to: https://console.cloud.google.com/kubernetes/workload_/gcloud/us-east1-b/mycluster?project=PROJECT_ID
kubeconfig entry generated for mycluster.
NAME       LOCATION    MASTER_VERSION   MASTER_IP     MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS
mycluster  us-east1-b  1.27.2-gke.1200  xxx.xxx.xxx.xxx  e2-medium     1.27.2-gke.1200  3          RUNNING
```

## Cloud Build

Cloud Buildã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
substitutions:
  _CLOUDSDK_COMPUTE_ZONE: è‡ªèº«ã®ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®š
  _CLOUDSDK_CONTAINER_CLUSTER: ã‚¯ãƒ©ã‚¹ã‚¿åã‚’æŒ‡å®š
  _PROJECT_ID: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŒ‡å®š
  _IMAGE_NAME: ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’æŒ‡å®š
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/${_PROJECT_ID}/${_IMAGE_NAME}:latest', '.']
  id: docker build
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/${_PROJECT_ID}/myimage:latest']
  id: docker push
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['container', 'clusters', 'get-credentials', '${_CLOUDSDK_CONTAINER_CLUSTER}', '--zone','${_CLOUDSDK_COMPUTE_ZONE}','--project', '${_PROJECT_ID}']
  id: gcloud container clusters get-credentials
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', 'k8s-sample.yaml']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=${_CLOUDSDK_COMPUTE_ZONE}'
  - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLOUDSDK_CONTAINER_CLUSTER}'
  id: kubectl apply
```

ç¶šã„ã¦ã€Cloud Buildã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
Cloud Build>ãƒˆãƒªã‚¬ãƒ¼ã§ä½œæˆã—ã¾ã™ã€‚

![](/images/2023-07-30-13_48_37.png)

## Cloud Buildã‚’å®Ÿè¡Œã™ã‚‹

```bash
git add .
git commit -m "cloud build test" 
git push origin master
```

ç¶šã„ã¦ã€Cloud Buildã®ç”»é¢ã§ãƒ“ãƒ«ãƒ‰çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã€‚

403ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯ã€Cloud BuildãŒä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã€ŒKubernetes Engineé–‹ç™ºè€…ã€ã®å½¹å‰²ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚
Cloud Build>è¨­å®š>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¨©é™ã€ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æœ‰åŠ¹ã«ã§ãã¾ã™ã€‚


## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

Cloud Buildã§ã®ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰ã€ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
 kubectl get service 
```

```bash
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)          AGE
k8s-sample   LoadBalancer   xxx.xxx.xxx.xxx   xxx.xxx.xxx.xxx   8080:32652/TCP   2m36s
kubernetes   ClusterIP      xxx.xxx.xxx.xxx     <none>          443/TCP          47m
```

ä¸Šè¨˜ã®k8s-sampleã®EXTERNAL-IPã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦ã€ãƒãƒ¼ãƒˆ8080ã§é–‹ãã¾ã™ã€‚

http://EXTERNAL-IPã®IPã‚¢ãƒ‰ãƒ¬ã‚¹:8080

ã™ã‚‹ã¨ã€ã€ŒHello, World!ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚


ã“ã“ã§ã€æ¬¡ã®ãŸã‚ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚

```
kubectl delete -f k8s-sample.yaml
deployment.apps "k8s-sample" deleted
service "k8s-sample" deleted
```

# Cloud Buildã¨Artifact Registryã€GKEã«ã‚ˆã‚‹CI/CDåŸºç›¤æ§‹ç¯‰

ç¶šã„ã¦ã€GCRã‹ã‚‰Artifact Registryã«å¤‰æ›´ã—ã¦ã„ãã¾ã™ã€‚

Container Registryã¯2023å¹´5æœˆ15æ—¥ã‹ã‚‰éæ¨å¥¨ã«ãªã£ã¦ãŠã‚Šã€Artifact Registryã«ç½®ãæ›ãˆã¦ã„ãã¾ã™ã€‚
https://cloud.google.com/container-registry/docs/deprecations/container-registry-deprecation?hl=ja&_ga=2.110856261.-1589395183.1689997200

## Artifact Registryã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ

```bash
gcloud artifacts repositories create cloud-build-sample --repository-format=docker --location=<REGION> --description="Docker repository"
```

```bash
Create request issued for: [cloud-build-sample]
Waiting for operation [projects/PROJECT_ID/locations/REGION/operations/610418cb-8ec6-4788-aae4-db99be7f4f93] to complete...done.                                                
Created repository [cloud-build-sample].
```

ä½œæˆå¾Œã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¸€è¦§ãŒç¢ºèªã§ãã¾ã™ã€‚

```bash
gcloud artifacts repositories list
```

```bash
Listing items under project PROJECT_ID, across all locations.

                                                                      ARTIFACT_REGISTRY
REPOSITORY          FORMAT  MODE                 DESCRIPTION        LOCATION  LABELS  ENCRYPTION          CREATE_TIME          UPDATE_TIME          SIZE (MB)
cloud-build-sample  DOCKER  STANDARD_REPOSITORY  Docker repository  REGION          Google-managed key  2023-07-30T14:40:03  2023-07-30T14:40:03  0
```

## Artifact Registryã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®èªè¨¼

ä»¥ä¸‹ã®REGIONã«ã¯ã€è‡ªèº«ã®ç’°å¢ƒã§ã®è¨­å®šã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚

```bash
gcloud auth configure-docker REGION-docker.pkg.dev 
```

## ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®Artifact Registryã®æ›¸ãè¾¼ã¿æ¨©é™ä»˜ä¸

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸Artifact Registryã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```bash
gcloud projects add-iam-policy-binding noted-ability-320105 \
  --member="serviceAccount:435683986349@cloudbuild.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"
```

```bash
Updated IAM policy for project [noted-ability-320105].
...
```

æ¨©é™ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

```bash
gcloud projects get-iam-policy PROJECT_ID
```

ä»¥ä¸‹ã®ã‚ˆã†ã«`roles/artifactregistry.writer`ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚Œã°OKã§ã™ã€‚

```bash
- members:
  - serviceAccount:<project-number>@cloudbuild.gserviceaccount.com
  role: roles/artifactregistry.writer
```

ç¶šã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`roles/artifactregistry.reader`ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```bash
gcloud artifacts repositories add-iam-policy-binding cloud-build-sample --member="serviceAccount:<project-number>@cloudbuild.gserviceaccount.com" --role="roles/artifactregistry.reader" --location="<zone>"

```


## cloudbuild.yamlã®ä¿®æ­£

cloudbuild.yamlã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```yaml
substitutions:
  _CLOUDSDK_COMPUTE_REGION: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
  _CLOUDSDK_COMPUTE_ZONE: ã‚¾ãƒ¼ãƒ³
  _CLOUDSDK_CONTAINER_CLUSTER: ã‚¯ãƒ©ã‚¹ã‚¿å
  _PROJECT_ID: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
  _DIRECTORY: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå
  _IMAGE_NAME: ã‚¤ãƒ¡ãƒ¼ã‚¸å
steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', '${_CLOUDSDK_COMPUTE_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_DIRECTORY}/${_IMAGE_NAME}:latest', '.']
  id: docker build
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', '${_CLOUDSDK_COMPUTE_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_DIRECTORY}/${_IMAGE_NAME}:latest']
  id: docker push
- name: 'gcr.io/cloud-builders/gcloud'
  args: ['container', 'clusters', 'get-credentials', '${_CLOUDSDK_CONTAINER_CLUSTER}', '--zone','${_CLOUDSDK_COMPUTE_ZONE}','--project', '${_PROJECT_ID}']
  id: gcloud container clusters get-credentials
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', 'k8s-sample.yaml']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=${_CLOUDSDK_COMPUTE_ZONE}'
  - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLOUDSDK_CONTAINER_CLUSTER}'
  id: kubectl apply
```

Artifact Registry ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä¿å­˜ã™ã‚‹ã•ã¾ã–ã¾ãªæ–¹æ³•ã®ä¾‹ã¯ä»¥ä¸‹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://cloud.google.com/build/docs/building/build-containers?hl=ja#store-images

`name`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§å‚ç…§ã™ã‚‹ãƒ“ãƒ«ãƒ€ãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¾‹ã¯ä»¥ä¸‹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
`name`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ã€ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡ã™ã‚ˆã†ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
https://cloud.google.com/build/docs/cloud-builders?hl=ja#supported_builder_images_provided_by